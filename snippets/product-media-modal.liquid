{% comment %}
  Renders a product media modal. Also see 'product-media-gallery'

  Accepts:
  - product: {Object} Product liquid object
  - variant_images: {Array} Product images associated with a variant

  Usage:
  {% render 'product-media-modal' %}
{% endcomment %}

{% if section.settings.enable_single_image_zoom %}
    <product-modal-single id="ProductModal-{{ section.id }}" class="product-media-modal media-modal"
                          data-zoom-single="true">
        <div class="product-media-modal__dialog color-{{ section.settings.color_schema }} gradient" role="dialog"
             aria-label="{{ 'products.modal.label' | t }}" aria-modal="true" tabindex="-1">
            <button id="ModalClose-{{ section.id }}" type="button" class="product-media-modal__toggle"
                    aria-label="{{ 'accessibility.close' | t }}">
                {{ 'icon-close.svg' | inline_asset_content }}
            </button>
            <div class="sp-zoom-container product-media-modal__content color-{{ section.secttings.color_scheme }} gradient"
                 role="document"
                 tabindex="0">
                <div class="sp-product-zoom-media">
                    <div class="product-modal-nav-arrows">
                        <button class="product-modal-nav-button product-modal-prev"
                                aria-label="{{ 'general.slider.previous_slide' | t }}">
                            <span class="svg-wrapper">{{- 'icon-caret.svg' | inline_asset_content -}}</span>
                        </button>
                        <div class="product-modal-main-image">
                            {% if product.selected_or_first_available_variant.featured_media != null %}
                                {% assign media = product.selected_or_first_available_variant.featured_media %}
                                <div data-media-id="{{ media.id }}" class="product-modal-media-container sp-zoom-img">
                                    <div class="product-modal-image-loader">
                                        <div class="product-modal-spinner"></div>
                                    </div>
                                    {% render 'cstm-product-media',
                                            media: media,
                                            loop: section.settings.enable_video_looping,
                                            variant_image: section.settings.hide_variants
                                    %}
                                </div>
                            {% endif %}

                            {% for media in product.media %}
                                {% unless media.id == product.selected_or_first_available_variant.featured_media.id %}
                                    {% liquid
                                        if section.settings.hide_variants and variant_images contains media.src or variant_images contains media.id
                                            assign variant_image = true
                                        else
                                            assign variant_image = false
                                        endif
                                    %}
                                    <div data-media-id="{{ media.id }}"
                                         class="product-modal-media-container sp-zoom-img hidden">
                                        <div class="product-modal-image-loader">
                                            <div class="product-modal-spinner"></div>
                                        </div>
                                        {% render 'cstm-product-media',
                                                media: media,
                                                loop: section.settings.enable_video_looping,
                                                variant_image: variant_image
                                        %}
                                    </div>
                                {% endunless %}
                            {% endfor %}

                        </div>
                        <button
                                class="product-modal-nav-button product-modal-next"
                                aria-label="{{ 'general.slider.next_slide' | t }}"
                        >
                        <span class="svg-wrapper" style="transform: rotate(180deg);">
                            {{- 'icon-caret.svg' | inline_asset_content -}}
                        </span>
                        </button>
                    </div>
                </div>

                <div class="product-modal-thumbnails">
                    {% if product.selected_or_first_available_variant.featured_media != null %}
                        <button
                                class="product-modal-thumbnail active"
                                data-media-id="{{ product.selected_or_first_available_variant.featured_media.id }}"
                        >
                            {{
                            product.selected_or_first_available_variant.featured_media
                            | image_url: width: 100
                            | image_tag: loading: 'lazy', alt: product.selected_or_first_available_variant.featured_media.alt
                            }}
                        </button>
                    {% endif %}

                    {% for media in product.media %}
                        {% unless media.id == product.selected_or_first_available_variant.featured_media.id %}
                            {% liquid
                                if section.settings.hide_variants and variant_images contains media.src or variant_images contains media.id
                                    continue
                                endif
                            %}

                            <button class="product-modal-thumbnail"
                                    data-media-id="{{ media.id }}">
                                {{ media | image_url: width: 100 | image_tag: loading: 'lazy', alt: media.alt }}
                            </button>

                        {% endunless %}
                    {% endfor %}

                </div>
            </div>
        </div>
    </product-modal-single>
{% else %}
    <product-modal id="ProductModal-{{ section.id }}" class="product-media-modal media-modal">
        <div
                class="product-media-modal__dialog color-{{ section.settings.color_scheme }} gradient"
                role="dialog"
                aria-label="{{ 'products.modal.label' | t }}"
                aria-modal="true"
                tabindex="-1"
        >
            <button
                    id="ModalClose-{{ section.id }}"
                    type="button"
                    class="product-media-modal__toggle"
                    aria-label="{{ 'accessibility.close' | t }}"
            >
                {{ 'icon-close.svg' | inline_asset_content }}
            </button>

            <div
                    class="product-media-modal__content color-{{ section.settings.color_scheme }} gradient"
                    role="document"
                    aria-label="{{ 'products.modal.label' | t }}"
                    tabindex="0"
            >
                {%- liquid
                    if product.selected_or_first_available_variant.featured_media != null
                        assign media = product.selected_or_first_available_variant.featured_media
                        render 'cstm-product-media', media: media, loop: section.settings.enable_video_looping, variant_image: section.settings.hide_variants
                    endif
                -%}

                {%- for media in product.media -%}
                    {%- liquid
                        if section.settings.hide_variants and variant_images contains media.src or variant_images contains media.id
                            assign variant_image = true
                        else
                            assign variant_image = false
                        endif

                        unless media.id == product.selected_or_first_available_variant.featured_media.id
                            render 'cstm-product-media', media: media, loop: section.settings.enable_video_looping, variant_image: variant_image
                        endunless
                    -%}
                {%- endfor -%}
            </div>
        </div>
    </product-modal>
{% endif %}

<style>
    /* Modal fade in/out animations */
    .product-media-modal {
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
        pointer-events: none;
    }

    .product-media-modal.is-open {
        opacity: 1;
        pointer-events: auto;
    }

    .product-media-modal__dialog {
        transform: scale(0.9) translateY(-20px);
        transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s ease-in-out;
        opacity: 0;
    }

    .product-media-modal.is-open .product-media-modal__dialog {
        transform: scale(1) translateY(0);
        opacity: 1;
    }

    /* Media container animations - simplified to prevent flickering */
    .product-modal-media-container {
        opacity: 0;
        transition: opacity 0.25s ease-in-out;
    }

    .product-modal-media-container:not(.hidden) {
        opacity: 1;
    }

    /* Thumbnail animations - reduced to prevent aggressive zoom */
    .product-modal-thumbnail {
        transform: scale(1);
        transition: transform 0.15s ease-in-out, border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }

    .product-modal-thumbnail:hover {
        transform: scale(1.02);
    }

    .product-modal-thumbnail.active {
        transform: scale(1.05);
        transition: transform 0.2s ease-in-out, border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }

    /* Navigation button animations */
    .product-modal-nav-button {
        transform: scale(1);
        transition: transform 0.2s ease-in-out, background-color 0.2s ease-in-out, opacity 0.2s ease-in-out;
        opacity: 0.8;
    }

    .product-modal-nav-button:hover {
        transform: scale(1.1);
        opacity: 1;
    }

    .product-modal-nav-button:active {
        transform: scale(0.95);
    }

    /* Close button animation */
    .product-media-modal__toggle {
        transform: scale(1);
        transition: transform 0.2s ease-in-out, opacity 0.2s ease-in-out;
        opacity: 0.8;
    }

    .product-media-modal__toggle:hover {
        transform: scale(1.1) rotate(90deg);
        opacity: 1;
    }

    /* Image loading animation - simplified to prevent zoom flickering */
    .sp-zoom-img img, .product-modal-media-container img {
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
    }

    .sp-zoom-img img.loaded, .product-modal-media-container img.loaded {
        opacity: 1;
    }

    /* Hide images while loader is visible */
    .product-modal-media-container:has(.product-modal-image-loader:not(.hidden)) img {
        opacity: 0;
    }

    /* Smooth scrolling for thumbnails */
    .product-modal-thumbnails {
        scroll-behavior: smooth;
    }

    /* Image loader styles */
    .product-modal-image-loader {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 10;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 1;
        transition: opacity 0.3s ease-in-out;
    }

    .product-modal-image-loader.hidden {
        opacity: 0;
        pointer-events: none;
    }

    /* Spinner animation */
    .product-modal-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-top: 3px solid #ffffff;
        border-radius: 50%;
        animation: modalSpinner 1s linear infinite;
        background: rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(2px);
    }

    @keyframes modalSpinner {
        0% {
            transform: rotate(0deg);
        }
        100% {
            transform: rotate(360deg);
        }
    }

    /* Skeleton loader for thumbnails */
    .product-modal-thumbnail.loading {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: modalSkeleton 1.5s ease-in-out infinite;
    }

    @keyframes modalSkeleton {
        0% {
            background-position: 200% 0;
        }
        100% {
            background-position: -200% 0;
        }
    }

    /* Media container positioning for loader */
    .product-modal-media-container {
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 300px;
    }

    .sp-quick-view-container .product-media-modal__content > *:not(.active), .product__media-list .deferred-media {
        display: block;
    }

    .sp-zoom-img {
        max-height: 600px;
        object-fit: cover;
    }

    .sp-zoom-img img {
        max-height: 600px;
        object-fit: contain;
        width: 100%;
    }

    .sp-quick-view-container .product-modal-thumbnails {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin: 20px 20px 0;
        overflow: auto;
    }

    .sp-quick-view-container .product-modal-thumbnail:first-child {
        margin-left: 70px;
    }

    .sp-quick-view-container .product-modal-thumbnail:last-child {
        margin-right: 5px;
    }

    .sp-quick-view-container .product-modal-thumbnail {
        min-width: 60px;
        width: 60px;
        height: 60px;
        border: 1px solid #e8e8e8;
        padding: 2px;
        cursor: pointer;
        background: none;
        border-radius: 4px;
        overflow: hidden;
        touch-action: manipulation;
    / Improve touch behavior /
    }

    .product-modal-thumbnail.active {
        border-color: #000;
        box-shadow: 0 0 0 1px #000;
    }

    .product-modal-thumbnail img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .hidden {
        display: none !important;
    }

    .product-modal-media-container {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        overflow: hidden;
    }

    .product-media-modal .product-modal-thumbnails {
        display: flex;
        gap: 10px;
        margin: 20px auto;
        overflow: auto;
        width: 80%;
        padding-block: 5px;
    }

    .product-media-modal .product-modal-thumbnails::-webkit-scrollbar {
        height: 3px;
    }

    .product-media-modal button.product-modal-thumbnail.media-fit-cover {
        min-width: 60px;
        width: 60px;
        height: 60px;
        border: 1px solid #e8e8e8;
        padding: 2px;
        cursor: pointer;
        background: none;
        border-radius: 4px;
        overflow: hidden;
        touch-action: manipulation;
    }

    @media screen and (min-width: 749px) {
        .product-media-modal .product-modal-thumbnails {
            max-width: 749px;
            margin: 20px auto 0;
            padding: 4px 0;
            text-align: center;
        }
    }

    @media screen and (min-width: 749px) {
        .sp-product-zoom-media button.product-modal-nav-button.product-modal-prev {
            /*transform: rotate(0deg);*/
        }


        /* .product-media-modal__content{
          overflow: hidden;
        } */
        .sp-quick-view-container .product-modal-thumbnails {
            max-width: 749px;
            margin: 20px auto 0;
        }

    {% comment %} .product-modal-thumbnails::-webkit-scrollbar {
      display: none;
    }

    /* Hide scrollbar for IE, Edge and Firefox */
    .product-modal-thumbnails {
      -ms-overflow-style: none;  /* IE and Edge */
      scrollba
  } {% endcomment %}
    / Mobile-specific styles /
    }

    @media screen and (max-width: 749px) {
        .product-modal-thumbnails {
            gap: 8px;
        }

        .sp-zoom-img img {
            height: 300px;
        }

        .product-modal-thumbnail {
            width: 50px;
            height: 50px;
        }

    / Make sure modal content is properly sized for mobile /
    .product-media-modal__content {
        width: 100%;
        height: auto;
        max-height: 80vh;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch; / Smooth scrolling on iOS /
    }

    / Ensure media fits properly on mobile screens /
    .product-modal-media-container img,
    .product-modal-media-container video,
    .product-modal-media-container model-viewer {
        max-width: 100%;
        max-height: 60vh;
        width: auto;
        height: auto;
        object-fit: contain;
    }
    / Navigation arrows for mobile /
    .product-modal-nav-arrows {
        display: flex;
        justify-content: space-between;
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 100%;
        padding: 0 15px;
        pointer-events: none;
        z-index: 2;
    }

        .product-modal-nav-button {
            background: rgba(255, 255, 255, 0.8);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            pointer-events: auto;
            transition: background-color 0.2s ease;
        }

        .product-modal-nav-button:hover {
            background: rgba(255, 255, 255, 0.95);
        }

        .product-modal-nav-button .svg-wrapper {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .product-modal-prev .svg-wrapper {
            /*transform: rotate(90deg);*/
        }

        .product-modal-next .svg-wrapper {
            transform: rotate(-90deg);
        }

        .sp-quick-view-container .product-modal-thumbnail:first-child {
            margin-left: unset;
        }

        .sp-quick-view-container .product-modal-thumbnails {
            display: flex !important;
        }
    }
</style>

