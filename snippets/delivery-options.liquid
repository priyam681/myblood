<div class="delivery-options">
    <div class="delivery-title-heading">
        <h2 class="delivery-title">{{ block.settings.section_heading }}</h2>
            <svg class="delivery-icon" width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
            <rect width="32" height="32" fill="url(#pattern0_5959_1271)"/>
            <defs>
            <pattern id="pattern0_5959_1271" patternContentUnits="objectBoundingBox" width="1" height="1">
            <use xlink:href="#image0_5959_1271" transform="scale(0.0104167)"/>
            </pattern>
            <image id="image0_5959_1271" width="96" height="96" preserveAspectRatio="none" xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGAAAABgCAYAAADimHc4AAAACXBIWXMAAAsTAAALEwEAmpwYAAAD/0lEQVR4nO2cvY8UNxjGfyDICXGHoEHciUggOoQoaEJShONQULqko+YAUfMhCIiC5C9IdwQh2hQBdERQQJI24itSChJoDiiBRCR8CdJgZMnbbNazM57xjL33/KSnWc16ntfveOzx2ANCCCGEEEIIIYQQQgghhBBCCCEWOzuBs8A94BVgMtEr4L7zPk2GbAJ+SaAiTUP6GfiQTPgE+DuBSjMN6y9gGxlc+aNY+cbpSeotYZRuO8ajH0mUmQQqx7SkJG9FZz1m3wCHgHXkwyRw2HkfFNO3JMh9j1lb+blyxBPTLRLkhcdsTlf+oJbQ5K3rLfAI+B74AlhKg/hOmjsmon5vsj9RAghuFV/GNJo7pgX9B3wUy2jumJZkBzHLYxjNHdOi9sUwmjumwbhWAbPAS0+Zd4ElKRhNCRMhrj0F5X6ektEUMBHislf5H55yr6VkNAVMpLgOFJS9NSWjXWMixTUGPPaUfS4lo11jIsb1dcHDWeUpHCWgOmsLZlxPVy1MCQjjvKf8p8CKKgUpAWFsAd55zrG/SkFKQDjXC6YnSj+YLbYEmJZU+sFMCSCKSj+YKQFEke0fNtcxmjsmAX1Tx2jumARUahGAEkA0Pa1jNHdMi3EtKegHkjLaJm3HFXw+JaAZlIA+lICOMUpAtxgloFuMEtAtZrEkYAI4CFwEHgKvnR663w66Y9pmWFwT7gX7BWDB7bCs47v1BNjleKeA5wVl9PQvcLLuEr6K+Lz0fD9r2HerCZgCfisRQL/uuLX7beDzcDOS79YSsN5tVjCBeuASGJtQf6G+W0nAmJvhqxvMDeAD8krAMN/BCaiyRelkg8EcI78E+HxPeY61/WPwJj2727B/hbAvWVaXgE+BlU47gPmC458D48SjbIVecF57vqddLFV8H/Uc+2cZo995/vzGJaHX+cwWmLIGfBwv+N9e4lGm8ot2gh4t4XvS7ch86zluruyXUeo0SXuVD+NKxFuCCZQd6w+jqAWXkb0jlOKnGiexO+2H8VkCFW4CKme6RvmVlqtvdF8VCTnR6hLlr0mgwk2fyvQ/EzVeRW6gIh8HJkEJ4H+Vv51ANhYst/NpV4lydydQ4aZPduTTdP94LeTKH4Q1d8YNo3wb06p8BuZqAhVu+mSHmsO4PKSMl27L0lyVDjeU2cCHqhMdDUOpOXw+1rHvgffDopnPy67JrnT3152udRTNNI4n4HveeR13mknEd+WHqqo6It/VGXMTUnWD+LWFybhR8D2QKTc1GxrEQovvBEbB90Am3UuKqkHc7vhDULn6HshyN8L5p0QA9pivgGVdm87Yt5dx93L7B9dMey/lF9xvB7ocNYygbyGEEEIIIYQQQgghhBBCkDbvAe0QETXy8vnCAAAAAElFTkSuQmCC"/>
            </defs>
            </svg>
    </div>

    <div class="delivery-form-block" {{ block.shopify_attributes }}>
        <div class="delivery-form">
            <input
                    type="text"
                    class="delivery-input"
                    placeholder="{{ block.settings.placeholder_text }}"
            />
            <button class="delivery-button">{{ block.settings.button_label }}</button>
        </div>
        <p class="delivery-note">{{ block.settings.note_text }}</p>
    </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const deliveryInput = document.querySelector('.delivery-input');
    const deliveryButton = document.querySelector('.delivery-button');
    const deliveryForm = document.querySelector('.delivery-form');

    const lengthErrorMsg = document.createElement('p');
    lengthErrorMsg.classList.add('delivery-length-error');
    lengthErrorMsg.textContent = 'Maximum 10 characters allowed';
    lengthErrorMsg.style.color = 'red';
    lengthErrorMsg.style.fontSize = '12px';
    lengthErrorMsg.style.marginTop = '5px';
    lengthErrorMsg.style.display = 'none';

    const resultMessage = document.createElement('p');
    resultMessage.classList.add('delivery-result');

    // Only proceed if required elements exist
    if (!deliveryInput || !deliveryButton || !deliveryForm) return;

    // Add error message to DOM
    deliveryForm.parentNode.insertBefore(lengthErrorMsg, deliveryForm.nextSibling);

    // Function to clear all delivery status messages and restore default state
    function clearDeliveryStatus() {
      // Remove result message
      const existingResult = document.querySelector('.delivery-result');
      if (existingResult) existingResult.remove();

      // Reset button style
      deliveryButton.innerHTML = 'Check';
      deliveryButton.style.color = '';
      deliveryButton.classList.remove('delivery-available', 'delivery-unavailable');

      // Re-enable add to cart button if it was disabled
      const addToCartButton = document.querySelector('.product-form__submit');
      if (addToCartButton) {
        addToCartButton.removeAttribute('disabled');
        addToCartButton.removeAttribute('aria-disabled');
        addToCartButton.classList.remove('button--disabled');
      }

      // Remove any unavailability note
      const unavailableNote = document.querySelector('.delivery-unavailable-note');
      if (unavailableNote) unavailableNote.remove();
    }

    // Handle input validation - automatically clear status when input changes
    deliveryInput.addEventListener('input', () => {
      if (deliveryInput.value.length > 10) {
        lengthErrorMsg.style.display = 'block';
        deliveryInput.value = deliveryInput.value.substring(0, 10);
      } else {
        lengthErrorMsg.style.display = 'none';
      }

      // Auto-clear delivery status when input changes
      clearDeliveryStatus();
    });

    // Also clear on focus (when user clicks in the input field)
    deliveryInput.addEventListener('focus', clearDeliveryStatus);

    // Handle availability check
    deliveryButton.addEventListener('click', () => {
      const deliveryInputValue = deliveryInput.value.trim();

      // Clear previous status
      clearDeliveryStatus();

      if (deliveryInputValue === '') return;

      try {
        // Properly parse the JSON data from Liquid
        const availabilityList = {% if product.metafields.custom.product_availability.value %}{{ product.metafields.custom.product_availability.value | json }}{% else %}[]{% endif %};

        // Check if delivery is available for the entered pin code
        const isAvailable = availabilityList.some(available => available.pin_code === deliveryInputValue);

        if (isAvailable) {
          // Available: Show success message
          resultMessage.textContent = 'Delivery available in your area!';
          resultMessage.style.color = 'green';
          deliveryButton.innerHTML = 'Available';
          deliveryButton.style.color = 'green';
          deliveryButton.classList.add('delivery-available');
        } else {
          // Unavailable: Show error message
          resultMessage.textContent = 'Sorry, delivery not available in your area.';
          resultMessage.style.color = 'red';
          deliveryButton.innerHTML = 'Unavailable';
          deliveryButton.style.color = 'red';
          deliveryButton.classList.add('delivery-unavailable');

          // Disable add to cart button if it exists
          const addToCartButton = document.querySelector('.product-form__submit');
          if (addToCartButton) {
            addToCartButton.setAttribute('disabled', 'disabled');
            addToCartButton.setAttribute('aria-disabled', 'true');
            addToCartButton.classList.add('button--disabled');
          }
        }

        // Add result message to DOM
        deliveryForm.parentNode.insertBefore(resultMessage, deliveryForm.nextSibling);

      } catch (error) {
        console.error('Error checking delivery availability:', error);
      }
    });

    // Add a key event listener for pressing Enter in the input field
    deliveryInput.addEventListener('keypress', (event) => {
      if (event.key === 'Enter') {
        event.preventDefault(); // Prevent form submission
        deliveryButton.click(); // Trigger the check button
      }
    });

    // Auto-clear delivery status after 5 minutes (300000ms) of inactivity
    let inactivityTimer;

    function resetInactivityTimer() {
      clearTimeout(inactivityTimer);
      inactivityTimer = setTimeout(clearDeliveryStatus, 300000);
    }

    // Reset timer on user interactions
    deliveryInput.addEventListener('input', resetInactivityTimer);
    deliveryButton.addEventListener('click', resetInactivityTimer);
    document.addEventListener('click', resetInactivityTimer);
    document.addEventListener('keypress', resetInactivityTimer);

    // Initialize the inactivity timer
    resetInactivityTimer();
  });
</script>


{% comment %}<script>
  document.addEventListener('DOMContentLoaded', () => {
    const deliveryInput = document.querySelector('.delivery-input');
    const deliveryButton = document.querySelector('.delivery-button');
    const deliveryForm = document.querySelector('.delivery-form');

    // Create elements only once outside event handlers
    const errorMsg = document.createElement('p');
    errorMsg.classList.add('delivery-error');
    errorMsg.textContent = 'Maximum 10 characters allowed';
    errorMsg.style.color = 'red';
    errorMsg.style.fontSize = '12px';
    errorMsg.style.marginTop = '5px';
    errorMsg.style.display = 'none';

    const resultMessage = document.createElement('p');
    resultMessage.classList.add('delivery-result');

    // Only proceed if required elements exist
    if (!deliveryInput || !deliveryButton || !deliveryForm) return;

    // Add an error message to DOM
    deliveryForm.parentNode.insertBefore(errorMsg, deliveryForm.nextSibling);

    // Handle input validation
    deliveryInput.addEventListener('input', () => {
      if (deliveryInput.value.length > 10) {
        errorMsg.style.display = 'block';
        deliveryInput.value = deliveryInput.value.substring(0, 10); // Truncate to 10 chars
      } else {
        errorMsg.style.display = 'none';
      }
    });

    // Handle availability check
    deliveryButton.addEventListener('click', () => {
      const deliveryInputValue = deliveryInput.value.trim();

      // Remove any existing result message
      const existingResult = document.querySelector('.delivery-result');
      if (existingResult) existingResult.remove();

      if (deliveryInputValue === '') return;

      try {
        // Properly parse the JSON data from Liquid
        const availabilityList = {% if product.metafields.custom.product_availability.value %}{{ product.metafields.custom.product_availability.value | json }}{% else %}[]{% endif %};

        // Check if delivery is available for the entered pin code
        const isAvailable = availabilityList.some(available => available.pin_code === deliveryInputValue);

        // Update UI based on availability
        if (isAvailable) {
          resultMessage.textContent = 'Delivery available in your area!';
          resultMessage.style.color = 'green';
          deliveryButton.innerHTML = 'Available';
          deliveryButton.style.color = 'green';
        } else {
          resultMessage.textContent = 'Sorry, delivery not available in your area.';
          resultMessage.style.color = 'red';
          deliveryButton.innerHTML = 'Unavailable';
          deliveryButton.style.color = 'red';
        }

        // Add result message to DOM
        deliveryForm.parentNode.insertBefore(resultMessage, deliveryForm.nextSibling);
      } catch (error) {
        console.error('Error checking delivery availability:', error);
      }
    });
  });
</script>{% endcomment %}


<style>
    .delivery-options .delivery-title-heading {
        margin-bottom: 2rem;
        margin-top: 3.5rem;
        display: flex;
        gap: 1.3rem;
        align-items: center;
    }

    .delivery-title-heading .delivery-title {
        display: flex;
        align-items: center;
        font-size: 18px;
        font-weight: 500;
        line-height: 1;
        margin: 0;
    }

    .delivery-icon {
        width: 3rem;
        height: 3rem;
    }

    .delivery-form {
        display: flex;
        border-radius: 2px;
        border: 1px solid rgba(73, 73, 73, 0.50);
        overflow: hidden;
        max-width: 343px;
    }

    .delivery-input {
        flex: 1;
        padding: 10px;
        border: none;
        font-size: 14px;
    }

    .delivery-form .delivery-input:focus-visible {
        outline: none;
        outline-offset: none;
        box-shadow: none;
    }

    .delivery-button {
        color: #FF3200;
        font-size: 1.4rem;
        font-weight: 700;
        border: none;
        line-height: 1.8rem;
        padding: 1rem;
        background: none;
        cursor: pointer;
    }

    .delivery-note {
        font-size: 1.2rem;
        line-height: 1.8rem;
        font-weight: 400;
        margin-top: 1.4rem;
        margin-bottom: 3.1rem;
    }
</style>

